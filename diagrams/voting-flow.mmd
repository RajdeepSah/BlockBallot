sequenceDiagram
    participant Voter
    participant ElectionView
    participant EligibilityAPI
    participant VoteAPI
    participant KVStore
    participant SupabaseDB
    participant Blockchain
    participant SmartContract
    
    Voter->>ElectionView: View election
    ElectionView->>EligibilityAPI: GET /api/elections/:id/eligibility-status
    EligibilityAPI->>EligibilityAPI: Authenticate user
    EligibilityAPI->>KVStore: Get user data
    EligibilityAPI->>KVStore: Check eligibility record
    EligibilityAPI->>KVStore: Check vote flag (hasVoted)
    EligibilityAPI->>KVStore: Check access request
    KVStore-->>EligibilityAPI: Eligibility status
    EligibilityAPI-->>ElectionView: {eligible, hasVoted, accessRequest}
    
    alt Not Eligible & No Request
        ElectionView->>VoteAPI: POST /api/elections/:id/access-request
        VoteAPI->>KVStore: Check existing request
        VoteAPI->>KVStore: Create access request
        Note over VoteAPI,KVStore: access_request:{electionId}:{userId}<br/>status: pending
        VoteAPI-->>ElectionView: Request submitted
        ElectionView->>Voter: Show pending message
    else Eligible & Not Voted & Election Active
        Voter->>ElectionView: Select candidates
        ElectionView->>ElectionView: Validate all positions selected
        ElectionView->>VoteAPI: POST /api/vote
        VoteAPI->>VoteAPI: Authenticate user
        VoteAPI->>SupabaseDB: Get election
        VoteAPI->>VoteAPI: Check election dates (start/end)
        VoteAPI->>KVStore: Get user data
        VoteAPI->>KVStore: Verify eligibility
        VoteAPI->>KVStore: Check vote flag (prevent duplicate)
        VoteAPI->>KVStore: Create timestamped lock
        Note over VoteAPI,KVStore: vote:user:{electionId}:{userId}:{timestamp}-{uuid}<br/>status: pending
        VoteAPI->>KVStore: Double-check no final vote exists
        VoteAPI->>Blockchain: castVotes(positions[], candidates[])
        Blockchain->>SmartContract: castVotes()
        SmartContract-->>Blockchain: Transaction receipt
        Blockchain-->>VoteAPI: Transaction hash
        VoteAPI->>KVStore: Store user vote flag (NO tx_hash for privacy)
        Note over VoteAPI,KVStore: vote:user:{electionId}:{userId}<br/>status: completed, created_at
        VoteAPI->>KVStore: Store tx in anonymous registry
        Note over VoteAPI,KVStore: vote:tx:{electionId}:{txHash}<br/>timestamp, electionId (NO userId)
        VoteAPI->>KVStore: Remove lock
        VoteAPI-->>ElectionView: {txHash, success}
        ElectionView->>Voter: Show vote confirmation with receipt
    else Already Voted
        ElectionView->>Voter: Show already voted message
    else Election Not Active
        ElectionView->>Voter: Show election status message
    end
